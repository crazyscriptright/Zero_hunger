<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rescue Details</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @media (max-width: 768px) {
            .table-container {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="container mx-auto p-6">
        <h1 class="text-3xl font-bold text-center mb-8">üêæ Rescue Details üêæ</h1>

        <!-- Filters and Search -->
        <div class="flex flex-col md:flex-row items-center justify-between gap-6 mb-8">
            <input id="searchInput" class="p-3 w-full md:w-1/3 border rounded-lg focus:outline-none" placeholder="Search by location or condition..." />
            
            <!-- Date Range Filter -->
            <div class="flex items-center gap-2">
                <label>From:</label>
                <input type="date" id="dateFrom" class="p-2 border rounded-lg focus:outline-none">
                <label>To:</label>
                <input type="date" id="dateTo" class="p-2 border rounded-lg focus:outline-none">
            </div>
            
            <select id="statusFilter" class="p-3 border rounded-lg focus:outline-none">
                <option value="">All Statuses</option>
                <option value="Pending">Pending</option>
                <option value="Escalated">Escalated</option>
                <option value="Cancelled">Cancelled</option>
            </select>
            <select id="sortOptions" class="p-3 border rounded-lg focus:outline-none hidden">
                <option value="created_at">Sort by Date</option>
                <option value="rescue_location">Sort by Location</option>
                <option value="rescue_status">Sort by Status</option>
            </select>
            <select id="sortOrder" class="p-3 border rounded-lg focus:outline-none">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
            </select>

            <div class="flex items-center gap-2">
                <button onclick="downloadPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 whitespace-nowrap">
                    Download Report
                </button>
            </div>
            
    
        </div>

        <!-- Export Button -->

        <!-- Table to Display Rescues -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden table-container">
            <table id="rescuesTable" class="w-full">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="p-3 text-left">ID</th>
                        <th class="p-3 text-left">Location</th>
                        <th class="p-3 text-left">Condition</th>
                        <th class="p-3 text-left">Phone no</th>
                        <th class="p-3 text-left">Image</th>
                        <th class="p-3 text-left">Notes</th>
                        <th class="p-3 text-left">Status</th>
                        <th class="p-3 text-left">Date</th>
                    </tr>
                </thead>
                <tbody id="rescuesBody" class="divide-y divide-gray-200">
                    <!-- Rows will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
        <div class="flex justify-between items-center mt-4">
            <button id="prevPage" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Previous</button>
            <span id="pageInfo" class="text-lg"></span>
            <button id="nextPage" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Next</button>
        </div>

        <!-- Image Modal -->
        <div id="imageModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
            <div class="bg-white p-8 rounded-lg w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Dog Image</h2>
                <img id="modalImage" class="w-full h-64 object-cover rounded-lg" src="" alt="Dog Image">
                <button onclick="closeImageModal()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                    Close
                </button>
            </div> 
        </div>

        <!-- Notes Modal -->
        <div id="notesModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
            <div class="bg-white p-8 rounded-lg w-full max-w-md">
                <h2 class="text-2xl font-bold mb-4">Additional Notes</h2>
                <p id="modalNotes" class="text-gray-700"></p>
                <button onclick="closeNotesModal()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
                    Close
                </button>
            </div>
        </div>
    </div>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        let allRescues = []; // Store all rescues fetched from the backend
        let currentPage = 1;
        const rescuesPerPage = 5;

        // Fetch all rescues from the backend
        async function fetchAllRescues() {
            try {
                const response = await fetch("/rescues");
                const data = await response.json();
                allRescues = data.rescues; // Store all rescues
                renderTable(); // Render the table with the fetched data
            } catch (error) {
                console.error("Error fetching rescues:", error);
                alert("Failed to fetch rescue details. Please try again.");
            }
        }

        // Render the table with the current page's data
        function renderTable() {
            const filteredRescues = filterRescues(allRescues);
            const sortedRescues = sortRescues(filteredRescues);
            const paginatedRescues = paginateRescues(sortedRescues);

            const rescuesBody = document.getElementById("rescuesBody");
            rescuesBody.innerHTML = "";

            paginatedRescues.forEach(rescue => {
                const row = document.createElement("tr");
                row.className = "hover:bg-gray-50 transition-all duration-200";

                // Add table cells for each rescue
                row.innerHTML = `
                    <td class="p-3">${rescue.id}</td>
                    <td class="p-3">${rescue.rescue_location}</td>
                    <td class="p-3">${rescue.condition_of_dog}</td>
                    <td class="p-3">${rescue.contact_info}</td>
                    <td class="p-3">
                        ${rescue.dog_image_base64 ? `
                            <button onclick="openImageModal('${rescue.dog_image_base64}')" class="text-blue-500 hover:text-blue-700">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </button>
                        ` : "No Image"}
                    </td>
                    <td class="p-3">
                        ${rescue.additional_notes && rescue.additional_notes.length > 15 ? `
                            <span class="text-blue-500 cursor-pointer hover:underline" onclick="openNotesModal('${rescue.additional_notes}')">
                                ${rescue.additional_notes.substring(0, 15)}...
                            </span>
                        ` : rescue.additional_notes || "N/A"}
                    </td>
                    <td class="p-3">
                        <select onchange="updateStatus(${rescue.id}, this.value)" class="p-2 border rounded-lg focus:outline-none">
                            <option value="Pending" ${rescue.rescue_status === "Pending" ? "selected" : ""}>Pending</option>
                            <option value="Escalated" ${rescue.rescue_status === "Escalated" ? "selected" : ""}>Escalated</option>
                            <option value="Cancelled" ${rescue.rescue_status === "Cancelled" ? "selected" : ""}>Cancelled</option>
                        </select>
                    </td>
                    <td class="p-3">${new Date(rescue.created_at).toLocaleDateString()}</td>
                `;
                rescuesBody.appendChild(row);
            });

            // Update pagination info
            document.getElementById("pageInfo").innerText = `Page ${currentPage} of ${Math.ceil(filteredRescues.length / rescuesPerPage)}`;
        }

        // Filter rescues based on search, status, and date range
        function filterRescues(rescues) {
            const search = document.getElementById("searchInput").value.toLowerCase();
            const status = document.getElementById("statusFilter").value;
            const dateFrom = document.getElementById("dateFrom").value;
            const dateTo = document.getElementById("dateTo").value;

            return rescues.filter(rescue => {
                const matchesSearch = rescue.rescue_location.toLowerCase().includes(search) || 
                                     rescue.condition_of_dog.toLowerCase().includes(search);
                const matchesStatus = status ? rescue.rescue_status === status : true;
                
                // Date filtering
                const rescueDate = new Date(rescue.created_at);
                const fromDate = dateFrom ? new Date(dateFrom) : null;
                const toDate = dateTo ? new Date(dateTo + "T23:59:59") : null; // Include entire end day
                
                let matchesDate = true;
                if (fromDate && toDate) {
                    matchesDate = rescueDate >= fromDate && rescueDate <= toDate;
                } else if (fromDate) {
                    matchesDate = rescueDate >= fromDate;
                } else if (toDate) {
                    matchesDate = rescueDate <= toDate;
                }
                
                return matchesSearch && matchesStatus && matchesDate;
            });
        }

        // Sort rescues based on the selected option
        function sortRescues(rescues) {
            const sortBy = document.getElementById("sortOptions").value;
            const sortOrder = document.getElementById("sortOrder").value;

            return rescues.sort((a, b) => {
                if (sortBy === "created_at") {
                    return sortOrder === "asc" ? new Date(a.created_at) - new Date(b.created_at) : new Date(b.created_at) - new Date(a.created_at);
                } else {
                    return sortOrder === "asc" ? a[sortBy].localeCompare(b[sortBy]) : b[sortBy].localeCompare(a[sortBy]);
                }
            });
        }

        // Paginate rescues
        function paginateRescues(rescues) {
            const startIndex = (currentPage - 1) * rescuesPerPage;
            const endIndex = startIndex + rescuesPerPage;
            return rescues.slice(startIndex, endIndex);
        }

        // Pagination Controls
        function nextPage() {
            const totalPages = Math.ceil(filterRescues(allRescues).length / rescuesPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        // Open image modal
        function openImageModal(imageSrc) {
            document.getElementById("modalImage").src = imageSrc;
            document.getElementById("imageModal").classList.remove("hidden");
        }

        // Close image modal
        function closeImageModal() {
            document.getElementById("imageModal").classList.add("hidden");
        }

        // Open notes modal
        function openNotesModal(notes) {
            document.getElementById("modalNotes").textContent = notes;
            document.getElementById("notesModal").classList.remove("hidden");
        }

        // Close notes modal
        function closeNotesModal() {
            document.getElementById("notesModal").classList.add("hidden");
        }

        // Update status
        async function updateStatus(id, status) {
            try {
                const response = await fetch(`/update-status/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ status })
                });
                const data = await response.json();
                alert(data.message);
                fetchAllRescues(); // Refresh the list
            } catch (error) {
                console.error("Error updating status:", error);
                alert("Failed to update status. Please try again.");
            }
        }

        // Download PDF report with comprehensive details
        function downloadPDF() {
    const filteredRescues = filterRescues(allRescues);
    const sortedRescues = sortRescues(filteredRescues);

    const doc = new jsPDF('p', 'pt', 'a4');

    // Title
    doc.setFontSize(20);
    doc.setTextColor(40);
    doc.setFont('helvetica', 'bold');
    doc.text("ANIMAL RESCUE REPORT", 300, 40, { align: 'center' });

    // Report metadata
    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text(`Report generated on: ${new Date().toLocaleString()}`, 300, 60, { align: 'center' });

    // Date range info if specified
    const dateFrom = document.getElementById("dateFrom").value;
    const dateTo = document.getElementById("dateTo").value;
    let dateRangeText = "All Dates";

    if (dateFrom && dateTo) {
        dateRangeText = `From: ${new Date(dateFrom).toLocaleDateString()} To: ${new Date(dateTo).toLocaleDateString()}`;
    } else if (dateFrom) {
        dateRangeText = `From: ${new Date(dateFrom).toLocaleDateString()}`;
    } else if (dateTo) {
        dateRangeText = `To: ${new Date(dateTo).toLocaleDateString()}`;
    }

    doc.text(`Date Range: ${dateRangeText}`, 300, 75, { align: 'center' });

    // Status filter info if specified
    const statusFilter = document.getElementById("statusFilter").value;
    if (statusFilter) {
        doc.text(`Status Filter: ${statusFilter}`, 300, 90, { align: 'center' });
    }

    // Summary statistics
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text("SUMMARY STATISTICS", 40, 120);

    // Calculate counts
    const totalRescues = filteredRescues.length;
    const pendingCount = filteredRescues.filter(r => r.rescue_status === "Pending").length;
    const escalatedCount = filteredRescues.filter(r => r.rescue_status === "Escalated").length;
    const cancelledCount = filteredRescues.filter(r => r.rescue_status === "Cancelled").length;
    const withImagesCount = filteredRescues.filter(r => r.dog_image_base64).length;

    doc.setFontSize(12);
    doc.setFont('helvetica', 'normal');
    doc.text(`Total Rescues: ${totalRescues}`, 50, 140);
    doc.text(`Pending: ${pendingCount} (${Math.round((pendingCount / totalRescues) * 100)}%)`, 50, 160);
    doc.text(`Escalated: ${escalatedCount} (${Math.round((escalatedCount / totalRescues) * 100)}%)`, 50, 180);
    doc.text(`Cancelled: ${cancelledCount} (${Math.round((cancelledCount / totalRescues) * 100)}%)`, 50, 200);
    doc.text(`Cases with Images: ${withImagesCount} (${Math.round((withImagesCount / totalRescues) * 100)}%)`, 50, 220);

    // Detailed table
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text("DETAILED RESCUE RECORDS", 40, 260);

    // Table data
    const headers = [
        "ID",
        "Location",
        "Condition",
        "Phone",
        "Image",
        "Status",
        "Date"
    ];

    const data = sortedRescues.map(rescue => [
        rescue.id,
        rescue.rescue_location,
        rescue.condition_of_dog,
        rescue.contact_info,
        rescue.dog_image_base64 ? "Yes" : "No",
        rescue.rescue_status,
        new Date(rescue.created_at).toLocaleDateString()
    ]);

    doc.autoTable({
        head: [headers],
        body: data,
        startY: 280,
        margin: { horizontal: 40 },
        styles: {
            fontSize: 10,
            cellPadding: 5,
            overflow: 'linebreak'
        },
        columnStyles: {
            0: { cellWidth: 30 }, // ID
            1: { cellWidth: 80 }, // Location
            2: { cellWidth: 80 }, // Condition
            3: { cellWidth: 80 }, // Phone
            4: { cellWidth: 40 }, // Image
            5: { cellWidth: 60 }, // Status
            6: { cellWidth: 60 }  // Date
        },
        headStyles: {
            fillColor: [41, 128, 185],
            textColor: [255, 255, 255],
            fontStyle: 'bold'
        },
        alternateRowStyles: {
            fillColor: [240, 240, 240]
        },
        didDrawPage: function (data) {
            // Footer
            doc.setFontSize(10);
            doc.setTextColor(150);
            doc.text(
                `Page ${data.pageCount}`,
                data.settings.margin.left,
                doc.internal.pageSize.height - 10
            );
        }
    });

    // Save the PDF
    doc.save(`Rescue_Report_${new Date().toISOString().slice(0, 10)}.pdf`);
}
        // Attach event listeners
        document.getElementById("searchInput").addEventListener("input", () => {
            currentPage = 1;
            renderTable();
        });
        document.getElementById("statusFilter").addEventListener("change", () => {
            currentPage = 1;
            renderTable();
        });
        document.getElementById("dateFrom").addEventListener("change", () => {
            currentPage = 1;
            renderTable();
        });
        document.getElementById("dateTo").addEventListener("change", () => {
            currentPage = 1;
            renderTable();
        });
        document.getElementById("sortOptions").addEventListener("change", renderTable);
        document.getElementById("sortOrder").addEventListener("change", renderTable);
        document.getElementById("nextPage").addEventListener("click", nextPage);
        document.getElementById("prevPage").addEventListener("click", prevPage);

        // Fetch all rescues on page load
        fetchAllRescues();
    </script>
</body>
</html>